# RoninNVR NextGen Motion Detection Development Environment
#
# This Dockerfile creates a development environment with:
# - NVIDIA CUDA 12.6 + cuDNN
# - TensorRT 10.x for optimized inference
# - OpenCV with CUDA support for GPU-accelerated background subtraction
# - ByteTrack dependencies for multi-object tracking
#
# Build:
#   docker compose -f docker/docker-compose.nextgen.yml build
#
# Run interactive:
#   docker compose -f docker/docker-compose.nextgen.yml run --rm dev bash

# Use NVIDIA CUDA devel image for building (has nvcc compiler)
FROM nvidia/cuda:12.6.3-cudnn-devel-ubuntu24.04 AS builder

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    cmake \
    git \
    wget \
    unzip \
    pkg-config \
    python3 \
    python3-dev \
    python3-pip \
    python3-numpy \
    # OpenCV dependencies
    libgtk-3-dev \
    libavcodec-dev \
    libavformat-dev \
    libswscale-dev \
    libv4l-dev \
    libxvidcore-dev \
    libx264-dev \
    libjpeg-dev \
    libpng-dev \
    libtiff-dev \
    libatlas-base-dev \
    gfortran \
    libtbb-dev \
    libdc1394-dev \
    # Video codec support
    libgstreamer1.0-dev \
    libgstreamer-plugins-base1.0-dev \
    && rm -rf /var/lib/apt/lists/*

# Build OpenCV with CUDA support
WORKDIR /tmp

# Download OpenCV and opencv_contrib
ARG OPENCV_VERSION=4.10.0
RUN wget -q -O opencv.zip https://github.com/opencv/opencv/archive/${OPENCV_VERSION}.zip && \
    wget -q -O opencv_contrib.zip https://github.com/opencv/opencv_contrib/archive/${OPENCV_VERSION}.zip && \
    unzip -q opencv.zip && \
    unzip -q opencv_contrib.zip && \
    rm opencv.zip opencv_contrib.zip

# Build OpenCV with CUDA
RUN mkdir -p /tmp/opencv-${OPENCV_VERSION}/build && \
    cd /tmp/opencv-${OPENCV_VERSION}/build && \
    cmake \
        -D CMAKE_BUILD_TYPE=RELEASE \
        -D CMAKE_INSTALL_PREFIX=/usr/local \
        -D OPENCV_EXTRA_MODULES_PATH=/tmp/opencv_contrib-${OPENCV_VERSION}/modules \
        -D WITH_CUDA=ON \
        -D CUDA_ARCH_BIN="8.6" \
        -D CUDA_ARCH_PTX="" \
        -D ENABLE_FAST_MATH=ON \
        -D CUDA_FAST_MATH=ON \
        -D WITH_CUBLAS=ON \
        -D WITH_CUDNN=ON \
        -D OPENCV_DNN_CUDA=ON \
        -D WITH_NVCUVID=ON \
        -D WITH_NVCUVENC=OFF \
        -D BUILD_opencv_cudacodec=ON \
        -D WITH_GSTREAMER=ON \
        -D WITH_TBB=ON \
        -D BUILD_TESTS=OFF \
        -D BUILD_PERF_TESTS=OFF \
        -D BUILD_EXAMPLES=OFF \
        -D BUILD_opencv_python3=ON \
        -D PYTHON3_EXECUTABLE=/usr/bin/python3 \
        -D PYTHON3_INCLUDE_DIR=/usr/include/python3.12 \
        -D PYTHON3_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.12.so \
        -D OPENCV_GENERATE_PKGCONFIG=ON \
        .. && \
    make -j$(nproc) && \
    make install && \
    ldconfig

# ============================================================
# Final image
# ============================================================
FROM nvidia/cuda:12.6.3-cudnn-runtime-ubuntu24.04

WORKDIR /workspace

ENV DEBIAN_FRONTEND=noninteractive

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    python3-venv \
    python3-pip \
    python3-dev \
    build-essential \
    ffmpeg \
    libpq5 \
    libsm6 \
    libxext6 \
    libgl1 \
    libnuma1 \
    # OpenCV runtime dependencies
    libgtk-3-0 \
    libavcodec60 \
    libavformat60 \
    libswscale7 \
    libtbb12 \
    libdc1394-25 \
    libgstreamer1.0-0 \
    libgstreamer-plugins-base1.0-0 \
    # Development tools
    git \
    vim \
    htop \
    nvtop \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3 /usr/bin/python

# Copy OpenCV from builder
COPY --from=builder /usr/local/lib /usr/local/lib
COPY --from=builder /usr/local/include/opencv4 /usr/local/include/opencv4
COPY --from=builder /usr/local/lib/python3.12/dist-packages/cv2 /usr/local/lib/python3.12/dist-packages/cv2
RUN ldconfig

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
ENV PYTHONPATH="/usr/local/lib/python3.12/dist-packages:$PYTHONPATH"

# Upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Pin NumPy <2 for compatibility with OpenCV compiled against NumPy 1.x
RUN pip install --no-cache-dir "numpy<2"

# Install TensorRT from NVIDIA (for CUDA 12.x)
# Note: tensorrt package includes everything needed for Python inference
RUN pip install --no-cache-dir \
    tensorrt==10.7.0 \
    tensorrt-cu12==10.7.0 \
    tensorrt-cu12-bindings==10.7.0 \
    tensorrt-cu12-libs==10.7.0

# Install ByteTrack dependencies
RUN pip install --no-cache-dir \
    lap \
    scipy \
    cython \
    filterpy

# Install cython_bbox (requires compilation)
RUN pip install --no-cache-dir cython-bbox

# Copy and install backend requirements
COPY backend/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Install GPU-specific packages
RUN pip uninstall -y onnxruntime 2>/dev/null || true && \
    pip install --no-cache-dir onnxruntime-gpu

# Install additional development tools
RUN pip install --no-cache-dir \
    ipython \
    jupyter \
    matplotlib \
    seaborn \
    tqdm \
    memory_profiler \
    py-spy \
    ultralytics

# Force numpy<2 for compatibility with OpenCV compiled against NumPy 1.x
# (must be done after all pip installs since some packages try to upgrade it)
RUN pip install --no-cache-dir --force-reinstall "numpy<2"

# Verify installations
RUN python -c "import cv2; print(f'OpenCV: {cv2.__version__}')" && \
    python -c "import cv2; print(f'CUDA devices: {cv2.cuda.getCudaEnabledDeviceCount()}')" && \
    python -c "import tensorrt; print(f'TensorRT: {tensorrt.__version__}')" && \
    python -c "import onnxruntime; print(f'ONNX Runtime: {onnxruntime.__version__}')"

# Set working directory for mounted code
WORKDIR /workspace/ronin-nvr

# Default to bash for interactive development
CMD ["bash"]
