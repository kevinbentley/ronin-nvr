{
  "sessions": [
    {
      "files_touched": [
        "backend/Dockerfile",
        "docker-compose.yml",
        "frontend/nginx.conf",
        "frontend/src/services/api.ts"
      ],
      "id": "c61de208",
      "logged_at": "2026-01-05T06:25:41.989700",
      "summary": "Fixed video playback performance: 1) Added 4 uvicorn workers (was 1) for better backend concurrency. 2) Configured nginx to serve video files directly at /videos/ path, bypassing Python entirely - nginx handles Range requests natively and much more efficiently. Frontend API updated to use direct nginx path.",
      "task_id": "TASK-14"
    },
    {
      "files_touched": [
        "backend/app/services/streaming.py",
        "backend/app/services/camera_stream.py"
      ],
      "id": "054c298c",
      "logged_at": "2026-01-05T07:05:34.308238",
      "summary": "Added filesystem-based check to prevent duplicate ffmpeg processes across uvicorn workers. Each worker now checks if the HLS playlist was recently modified before starting a new stream - if active, it skips starting another ffmpeg process.",
      "task_id": "TASK-16"
    },
    {
      "files_touched": [
        "backend/stream_manager.py",
        "backend/app/services/stream_client.py",
        "docker-compose.yml",
        "backend/app/api/cameras.py",
        "backend/app/main.py",
        "backend/app/services/startup.py",
        "backend/app/services/status_monitor.py"
      ],
      "id": "7645eb2e",
      "logged_at": "2026-01-05T07:52:19.426851",
      "summary": "Implemented dedicated stream manager service to fix duplicate ffmpeg processes. Created stream_manager.py as standalone FastAPI service on port 8001 that owns all camera ffmpeg streams. Added stream_client.py with HTTP client and facade to maintain same interface. Added locking to prevent race conditions when multiple backend workers call start_stream concurrently. Result: 1 ffmpeg per camera (down from 4-8 duplicates).",
      "task_id": "TASK-16"
    },
    {
      "files_touched": [
        "backend/app/api/ml.py",
        "backend/app/schemas/ml.py",
        "frontend/src/types/camera.ts"
      ],
      "id": "d8299286",
      "logged_at": "2026-01-05T08:13:52.818738",
      "summary": "Fixed bug where live detection events weren't showing in timeline. The /ml/detections/timeline API was only querying detections linked to recordings (via recording_id), but live detections have recording_id=NULL. Added OR condition to also query live detections by camera_id and detected_at timestamp. Updated TimelineEvent schema to make recording_id optional.",
      "task_id": "TASK-17"
    },
    {
      "files_touched": [
        "backend/app/api/ml.py"
      ],
      "id": "1249e6bb",
      "logged_at": "2026-01-05T08:31:45.665088",
      "summary": "Fixed timezone issue in timeline events. The API was using UTC hour/minute/second directly when calculating event positions, but the timeline displays in local time. Now converts UTC timestamps to local timezone (from TZ env var) before calculating position. Also fixed the date range query to use local midnight boundaries converted to UTC.",
      "task_id": "TASK-17"
    },
    {
      "files_touched": [
        "backend/app/models/ml_settings.py",
        "backend/app/models/__init__.py",
        "backend/alembic/versions/20250105_add_ml_settings.py",
        "backend/app/schemas/ml.py",
        "backend/app/api/ml.py",
        "backend/live_detection_worker.py",
        "frontend/src/types/camera.ts",
        "frontend/src/services/api.ts",
        "frontend/src/pages/MLStatusPage.tsx",
        "frontend/src/pages/MLStatusPage.css"
      ],
      "id": "cf6f845c",
      "logged_at": "2026-01-05T09:36:21.752706",
      "summary": "Implemented configurable ML settings in the UI. Created ml_settings database table with Alembic migration, added GET/PUT API endpoints, updated live detection worker to reload settings from DB every 60 seconds, and built settings editor UI with sliders for confidence thresholds, FPS, cooldown, and checkbox selection for detection classes.",
      "task_id": "TASK-18"
    },
    {
      "files_touched": [
        "backend/transcode_worker.py"
      ],
      "id": "d477ed16",
      "logged_at": "2026-01-05T12:34:04.639336",
      "summary": "Fixed transcode worker VFR bug causing files to grow larger instead of smaller. Root cause: source camera files are VFR (variable frame rate) with r_frame_rate=100fps but actual ~15fps content. FFmpeg was duplicating frames to fill 100fps, causing 2-3x larger output files and 0.3x realtime speed. Fix: added -vsync vfr to preserve original frame timing. Results: files now save ~24% space at 2x realtime speed.",
      "task_id": "TASK-19"
    },
    {
      "files_touched": [
        "frontend/src/pages/PlaybackPage.css"
      ],
      "id": "4a04af7f",
      "logged_at": "2026-01-05T12:49:04.254978",
      "summary": "Fixed timeline events section visibility bug on playback page. The section was getting squeezed when video aspect ratio made the player tall. Added flex-shrink: 0 to prevent compression and increased height from 120px to 160px to properly accommodate the events track.",
      "task_id": "TASK-20"
    },
    {
      "files_touched": [
        "frontend/src/pages/PlaybackPage.css",
        "frontend/src/components/Timeline.css",
        "frontend/src/components/RecordingPlayer.css"
      ],
      "id": "c5a19536",
      "logged_at": "2026-01-05T13:56:10.873773",
      "summary": "Fixed timeline events section visibility on playback page. The events track was getting cut off when video aspect ratio made the player tall. Changed playback-main from flexbox to CSS Grid with minmax(0, 1fr) for player row, and set timeline-track to fixed 28px height instead of flex: 1.",
      "task_id": "TASK-20"
    },
    {
      "files_touched": [
        "backend/transcode_worker.py"
      ],
      "id": "e1de22b4",
      "logged_at": "2026-01-05T14:05:07.788114",
      "summary": "Added improved logging and NVDEC fixes to transcode worker: 1) -extra_hw_frames 8 to prevent decoder surface exhaustion, 2) -fflags +genpts to handle timestamp discontinuities, 3) stderr logging for FFmpeg warnings even on success, 4) --show-ffmpeg-output flag for real-time debugging",
      "task_id": "TASK-21"
    },
    {
      "files_touched": [
        "backend/transcode_worker.py",
        "backend/stream_manager.py"
      ],
      "id": "9ab0b87e",
      "logged_at": "2026-01-05T16:21:56.630634",
      "summary": "Fixed camera streaming issues: Ubiquiti cameras (7,8,9,10) require UDP transport instead of TCP. Also improved transcode worker with better logging, NVDEC surface fix, and timestamp handling. Fixed run_once() bug where _running flag wasn't set.",
      "task_id": "TASK-21"
    },
    {
      "files_touched": [
        "frontend/src/pages/MLStatusPage.tsx",
        "frontend/src/pages/MLStatusPage.css"
      ],
      "id": "fa5fcc74",
      "logged_at": "2026-01-05T16:26:35.134975",
      "summary": "Added clickable detection list with snapshot preview panel to ML Status page. Detection items now highlight on hover and show selected state. New snapshot preview panel displays the detection image with camera name, class, confidence, and timestamp.",
      "task_id": "TASK-23"
    },
    {
      "files_touched": [
        "backend/app/services/ml/recording_watcher.py"
      ],
      "id": "ce7e036d",
      "logged_at": "2026-01-05T16:59:30.620313",
      "summary": "Fixed duplicate key error in recording watcher. The code now handles IntegrityError by rolling back the session and fetching the existing record, preventing cascade failures to subsequent inserts.",
      "task_id": "TASK-25"
    },
    {
      "files_touched": [
        "backend/app/services/ml/recording_watcher.py",
        "backend/app/models/ml_job.py",
        "backend/alembic/versions/a15875f2b4cd_add_unique_constraint_on_ml_jobs_.py"
      ],
      "id": "464a82a5",
      "logged_at": "2026-01-05T17:25:57.598789",
      "summary": "Fixed \"Multiple rows found\" error by changing scalar_one_or_none() to scalars().first(). Also cleaned up 95 duplicate ML jobs and added unique constraint on (recording_id, model_name) to prevent future duplicates.",
      "task_id": "TASK-26"
    },
    {
      "files_touched": [
        "backend/live_detection_worker.py",
        "backend/app/services/ml/motion_gate.py",
        "backend/app/config.py"
      ],
      "id": "7747bf91",
      "logged_at": "2026-01-05T19:11:20.879612",
      "summary": "Fixed motion detection in live detection worker. Replaced broken MOG2 algorithm with frame differencing motion gate. Now extracts multiple frames per segment at 720p, uses motion as gate before YOLO inference, and processes cameras in parallel. The system correctly skips YOLO on static scenes, saving ~121ms per frame when no motion detected.",
      "task_id": "TASK-27"
    },
    {
      "files_touched": [
        "backend/app/api/ml.py",
        "frontend/src/pages/MLStatusPage.tsx",
        "frontend/src/pages/MLStatusPage.css",
        "frontend/src/services/api.ts",
        "frontend/src/types/camera.ts"
      ],
      "id": "64aebb32",
      "logged_at": "2026-01-05T19:18:16.337478",
      "summary": "Added pagination to ML page live detections: changed from 10 to 100 items per page with Previous/Next navigation. Updated backend API to support offset parameter and return total count, updated frontend types, API client, and added pagination controls with CSS styling.",
      "task_id": null
    },
    {
      "files_touched": [
        "backend/live_detection_worker.py",
        "backend/app/services/ml/motion_gate.py",
        "backend/app/config.py"
      ],
      "id": "d789fb6c",
      "logged_at": "2026-01-05T22:25:56.815842",
      "summary": "Fixed motion detection bug in live detection worker. The DetectionResult for motion events was missing the required class_id parameter, causing TypeError exceptions that prevented all detections from being saved. Added class_id=-1 for motion events. Motion detection now correctly stores events to database when frame differencing detects changes.",
      "task_id": null
    }
  ]
}
